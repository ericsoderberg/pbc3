<%= (@form.form_fields.select{|ff|
    ff.field_type != FormField::INSTRUCTIONS}.map{|ff| ff.name} +
  %w{user email} +
  (@form.payable ? %w{state payment date} : [])).join(',') %>
<%= @filled_forms.map do |filled_form|
  (filled_form.filled_fields.map{|ff| ff.value} +
  (filled_form.user ?
    [filled_form.user.name, filled_form.user.email]
    : ['anonymous', '']) +
  (@form.payable? ?
    (filled_form.payment ?
      [filled_form.payment.state, filled_form.payment.method, filled_form.payment.sent_at.strftime("%m/%d/%Y")]
      : ['unpaid', '', ''])
    : [])
  ).join(',')
end.join("\n") %>
